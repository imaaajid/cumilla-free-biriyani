<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cumilla Biriyani Tracker | Map Pro</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@lottiefiles/lottie-player@latest/dist/lottie-player.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <style>
        body { font-family: 'Hind Siliguri', sans-serif; transition: 0.3s; }
        #map { height: 350px; width: 100%; border-bottom: 4px solid #ea580c; z-index: 10; }
        .dark #map { filter: invert(100%) hue-rotate(180deg) brightness(95%) contrast(90%); }
        #preloader { position: fixed; inset: 0; background: white; z-index: 1000; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .dark #preloader { background: #111827; }
        .glass { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); }
        .dark .glass { background: rgba(31, 41, 55, 0.8); }
    </style>
</head>
<body class="bg-orange-50 dark:bg-gray-900 dark:text-gray-100 pb-40">

    <div id="preloader">
        <lottie-player src="https://assets2.lottiefiles.com/packages/lf20_m6cuL6.json" background="transparent" speed="1" style="width: 200px;" loop autoplay></lottie-player>
        <p class="text-orange-600 font-bold animate-pulse">‡¶Æ‡ßç‡¶Ø‡¶æ‡¶™ ‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá...</p>
    </div>

    <div class="bg-stone-900 text-white py-3 px-4 flex justify-between items-center sticky top-0 z-[60]">
        <div class="text-[11px] font-bold text-orange-400" id="countdown">‡¶á‡¶´‡¶§‡¶æ‡¶∞‡ßá‡¶∞ ‡¶¨‡¶æ‡¶ï‡¶ø: --:--:--</div>
        <button onclick="toggleDarkMode()" class="text-orange-400"><i id="dark-icon" class="fa-solid fa-moon"></i></button>
    </div>

    <div id="map"></div>

    <header class="py-6 px-4 text-center glass sticky top-[44px] z-50 border-b dark:border-gray-700">
        <h1 class="text-2xl font-black text-orange-600">CUMILLA BIRIYANI üçñ</h1>
        <p class="text-[10px] font-bold opacity-60 uppercase">Live Map View Enabled</p>
    </header>

    <main id="post-container" class="max-w-md mx-auto px-4 mt-8 space-y-6">
        </main>

    <div class="fixed bottom-6 left-1/2 -translate-x-1/2 w-full max-w-md px-4 z-40">
        <button onclick="toggleForm()" class="w-full bg-orange-600 text-white font-black py-4 rounded-3xl shadow-2xl flex items-center justify-center gap-3 border-4 border-white dark:border-gray-800">
            <i class="fa-solid fa-location-dot"></i> ‡¶¨‡¶ø‡¶∞‡¶ø‡ßü‡¶æ‡¶®‡¶ø ‡¶™‡ßü‡ßá‡¶®‡ßç‡¶ü ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶° ‡¶ï‡¶∞‡ßÅ‡¶®
        </button>
    </div>

    <div id="add-form" class="hidden fixed inset-0 bg-black/70 backdrop-blur-md flex items-end justify-center z-[110]">
        <div class="bg-white dark:bg-gray-800 w-full max-w-md p-8 rounded-t-[3rem]">
            <h2 class="text-xl font-bold mb-6">‡¶≤‡ßã‡¶ï‡ßá‡¶∂‡¶® ‡¶¶‡¶ø‡¶® üìù</h2>
            <input id="user-name" type="text" placeholder="‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶®‡¶æ‡¶Æ" class="w-full p-4 bg-gray-100 dark:bg-gray-700 rounded-2xl mb-3 outline-none">
            <input id="loc-name" type="text" placeholder="‡¶ú‡¶æ‡ßü‡¶ó‡¶æ‡¶∞ ‡¶®‡¶æ‡¶Æ" class="w-full p-4 bg-gray-100 dark:bg-gray-700 rounded-2xl mb-3 outline-none">
            <textarea id="loc-desc" placeholder="‡¶¨‡¶ø‡¶∏‡ßç‡¶§‡¶æ‡¶∞‡¶ø‡¶§..." class="w-full p-4 bg-gray-100 dark:bg-gray-700 rounded-2xl mb-6 outline-none h-24"></textarea>
            <div class="flex gap-4">
                <button onclick="toggleForm()" class="flex-1 font-bold text-gray-400">‡¶¨‡¶æ‡¶§‡¶ø‡¶≤</button>
                <button onclick="saveData()" id="submit-btn" class="flex-[2] bg-orange-600 text-white py-4 rounded-2xl font-black">‡¶™‡¶æ‡¶¨‡¶≤‡¶ø‡¶∂ ‡¶ï‡¶∞‡ßÅ‡¶®</button>
            </div>
        </div>
    </div>

    <script>
        const DB_URL = "https://cumilla-biriyani-default-rtdb.asia-southeast1.firebasedatabase.app/posts.json";
        let map, markersLayer;
        let userCoords = { lat: 23.4607, lon: 91.1809 }; // Default: Cumilla City

        // Initialize Map
        function initMap() {
            map = L.map('map').setView([userCoords.lat, userCoords.lon], 13);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
            markersLayer = L.layerGroup().addTo(map);
        }

        // Get User Location
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(pos => {
                userCoords = { lat: pos.coords.latitude, lon: pos.coords.longitude };
                map.setView([userCoords.lat, userCoords.lon], 14);
                L.marker([userCoords.lat, userCoords.lon]).addTo(map).bindPopup("‡¶Ü‡¶™‡¶®‡¶ø ‡¶è‡¶ñ‡¶æ‡¶®‡ßá").openPopup();
            });
        }

        async function fetchData() {
            const res = await fetch(DB_URL);
            const data = await res.json();
            const posts = data ? Object.keys(data).map(id => ({ id, ...data[id] })) : [];
            renderUI(posts);
        }

        function renderUI(posts) {
            const container = document.getElementById('post-container');
            container.innerHTML = "";
            markersLayer.clearLayers();

            posts.reverse().forEach(post => {
                // Add to List
                container.innerHTML += `
                    <div class="bg-white dark:bg-gray-800 rounded-[2rem] p-6 shadow-lg border dark:border-gray-700">
                        <h3 class="text-xl font-black">üìç ${post.location}</h3>
                        <p class="text-gray-500 text-sm mt-2">${post.description}</p>
                    </div>
                `;

                // Add to Map
                if (post.lat && post.lon) {
                    L.marker([post.lat, post.lon])
                        .addTo(markersLayer)
                        .bindPopup(`<b>${post.location}</b><br>${post.description}`);
                }
            });
            setTimeout(() => document.getElementById('preloader').style.display = 'none', 2000);
        }

        async function saveData() {
            const user = document.getElementById('user-name').value;
            const loc = document.getElementById('loc-name').value;
            const desc = document.getElementById('loc-desc').value;
            if(!loc) return alert("‡¶≤‡ßã‡¶ï‡ßá‡¶∂‡¶® ‡¶¶‡¶ø‡¶®");

            await fetch(DB_URL, { method: 'POST', body: JSON.stringify({
                user, location: loc, description: desc,
                lat: userCoords.lat, lon: userCoords.lon,
                timestamp: Date.now()
            })});
            toggleForm(); fetchData();
        }

        function toggleForm() { document.getElementById('add-form').classList.toggle('hidden'); }
        function toggleDarkMode() { document.documentElement.classList.toggle('dark'); }

        initMap();
        fetchData();

        // Countdown Fix
        setInterval(() => {
            const now = new Date();
            const iftar = new Date(); iftar.setHours(18, 15, 0);
            if (now > iftar) iftar.setDate(iftar.getDate() + 1);
            const diff = iftar - now;
            const h = Math.floor(diff/3600000), m = Math.floor((diff%3600000)/60000), s = Math.floor((diff%60000)/1000);
            document.getElementById('countdown').innerText = `‡¶á‡¶´‡¶§‡¶æ‡¶∞‡ßá‡¶∞ ‡¶¨‡¶æ‡¶ï‡¶ø: ${h}:${m}:${s}`;
        }, 1000);
    </script>
</body>
</html>
